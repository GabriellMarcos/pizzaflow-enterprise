name: ğŸš€ PizzaFlow Enterprise CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18.x'
  AWS_REGION: 'us-east-1'

jobs:
  test-backend:
    name: "ğŸ§ª Backend Tests"
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "ğŸ”§ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: "ğŸ“¦ Install backend dependencies"
        run: cd src/backend && npm ci

      - name: "ğŸ—ï¸ Build backend"
        run: cd src/backend && npm run build

  test-frontend:
    name: "ğŸ¨ Frontend Tests"
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "ğŸ”§ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: "ğŸ“¦ Install frontend dependencies"
        run: cd src/frontend && npm ci

      - name: "ğŸ—ï¸ Build frontend"
        run: cd src/frontend && npm run build

  auto-version:
    name: "ğŸ·ï¸ Auto Versioning"
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: "ğŸ“¥ Checkout code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "ğŸ·ï¸ Automatic versioning"
        uses: anothrNick/github-tag-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEFAULT_BUMP: patch
          WITH_V: true
          RELEASE_BRANCHES: main